@{
    ViewData["Title"] = "Inicio";

    int totalObras = (int)(ViewBag.TotalObras ?? 0);
    int obrasAtivas = (int)(ViewBag.ObrasAtivas ?? 0);
    int obrasInativas = Math.Max(totalObras - obrasAtivas, 0);
}
<!-- TOP STATS / INFO-BOXES -->
<div class="row g-3 mb-4">
    <div class="col-lg-3 col-6">
        <div class="card shadow-sm border-0 bg-success text-white h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-white-50 text-uppercase small mb-1">Obras Ativas</p>
                    <h3 class="mb-0 fw-bold">@obrasAtivas</h3>
                    <small class="text-white-50">Em execução neste momento</small>
                </div>
                <div class="display-5">
                    🏗️
                </div>
            </div>
            <div class="card-footer border-0 bg-transparent text-end">
                <a asp-controller="Obras" asp-action="Index" class="small text-white text-decoration-none">
                    Ver obras <span class="ms-1">»</span>
                </a>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="card shadow-sm border-0 bg-primary text-white h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-white-50 text-uppercase small mb-1">Total de Obras</p>
                    <h3 class="mb-0 fw-bold">@totalObras</h3>
                    <small class="text-white-50">Histórico de todas as obras</small>
                </div>
                <div class="display-5">
                    📋
                </div>
            </div>
            <div class="card-footer border-0 bg-transparent text-end">
                <a asp-controller="Obras" asp-action="Index" class="small text-white text-decoration-none">
                    Ver histórico <span class="ms-1">»</span>
                </a>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="card shadow-sm border-0 bg-warning text-dark h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-dark text-opacity-75 text-uppercase small mb-1">Clientes</p>
                    <h3 class="mb-0 fw-bold">@((ViewBag.TotalClientes ?? 0))</h3>
                    <small class="text-dark text-opacity-75">Clientes registados</small>
                </div>
                <div class="display-5">
                    👤
                </div>
            </div>
            <div class="card-footer border-0 bg-transparent text-end">
                <a asp-controller="Clientes" asp-action="Index" class="small text-dark text-decoration-none">
                    Ver clientes <span class="ms-1">»</span>
                </a>
            </div>
        </div>
    </div>

    <div class="col-lg-3 col-6">
        <div class="card shadow-sm border-0 bg-danger text-white h-100">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-white-50 text-uppercase small mb-1">Materiais</p>
                    <h3 class="mb-0 fw-bold">@((ViewBag.TotalMateriais ?? 0))</h3>
                    <small class="text-white-50">Itens em catálogo</small>
                </div>
                <div class="display-5">
                    🧱
                </div>
            </div>
            <div class="card-footer border-0 bg-transparent text-end">
                <a asp-controller="Materiais" asp-action="Index" class="small text-white text-decoration-none">
                    Ver materiais <span class="ms-1">»</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ROW: CHART + MOVIMENTOS -->
<div class="row g-3">
    <!-- CARD GRÁFICO (DOUGHNUT OBRAS) -->
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Distribuição de Obras</h5>
                    <small class="text-muted">Obras ativas/inativas</small>
                </div>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-7">
                        <canvas id="obrasChart" height="140"></canvas>
                    </div>
                    <div class="col-5">
                        <ul class="list-unstyled small mb-0">
                            <li class="mb-2">
                                <span class="badge bg-success me-1">&nbsp;</span>
                                <strong>@obrasAtivas</strong> obras ativas
                            </li>
                            <li class="mb-2">
                                <span class="badge bg-secondary me-1">&nbsp;</span>
                                <strong>@obrasInativas</strong> obras inativas
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CARD MOVIMENTOS -->
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">📦 Últimos Movimentos de Stock</h5>
                    <small class="text-muted">Entradas e saídas de materiais por obra</small>
                </div>
                <div class="btn-group btn-group-sm" role="group" aria-label="Filtro de movimentos">
                    <button type="button" class="btn btn-outline-secondary active" data-filter-operacao="ALL">
                        Todos
                    </button>
                    <button type="button" class="btn btn-outline-success" data-filter-operacao="ADD">
                        Entradas
                    </button>
                    <button type="button" class="btn btn-outline-danger" data-filter-operacao="REMOVE">
                        Saídas
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="tabela-movimentos" class="table table-striped table-hover table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 18%;">Data</th>
                                <th style="width: 26%;">Obra</th>
                                <th style="width: 26%;">Material</th>
                                <th style="width: 14%;">Operação</th>
                                <th style="width: 12%;" class="text-end">Qtd.</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ViewBag.MovimentosRecentes != null && ((IEnumerable<dynamic>)ViewBag.MovimentosRecentes).Any())
                            {
                                foreach (var mov in (IEnumerable<dynamic>)ViewBag.MovimentosRecentes)
                                {
                                    string operacao = mov.Operacao as string ?? "ADD";
                                    bool isRemove = operacao == "REMOVE";
                                    string rowClass = isRemove ? "table-danger" : "table-success";

                                    <tr class="@rowClass" data-operacao="@operacao">
                                        <td>@mov.DataOperacao.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td>@(mov.Obra?.Nome ?? "-")</td>
                                        <td>@(mov.Material?.Nome ?? "-")</td>
                                        <td class="text-center">
                                            @if (isRemove)
                                            {
                                                <span class="badge bg-danger">
                                                    - Saída
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">
                                                    + Entrada
                                                </span>
                                            }
                                        </td>
                                        <td class="fw-bold text-end">@mov.Quantidade</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-3">
                                        Nenhum movimento registado.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white border-0 text-end">
                <small class="text-muted">Registos mais recentes de movimentos de stock.</small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // 🔹 Filtro de movimentos por operação
            const filterButtons = document.querySelectorAll('[data-filter-operacao]');
            const rows = document.querySelectorAll('#tabela-movimentos tbody tr[data-operacao]');

            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const filtro = btn.getAttribute('data-filter-operacao');

                    // Atualizar estado visual dos botões
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Mostrar / esconder linhas
                    rows.forEach(row => {
                        const op = row.getAttribute('data-operacao');
                        if (filtro === 'ALL' || filtro === op) {
                            row.classList.remove('d-none');
                        } else {
                            row.classList.add('d-none');
                        }
                    });
                });
            });

            // 🔹 Gráfico doughnut: obras ativas vs inativas
            const obrasCtx = document.getElementById('obrasChart');
            if (obrasCtx) {
                const obrasAtivas = @obrasAtivas;
                const obrasInativas = @obrasInativas;

                new Chart(obrasCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Obras Ativas', 'Outras Obras'],
                        datasets: [{
                            data: [obrasAtivas, obrasInativas],
                            backgroundColor: [
                                '#198754', // verde Bootstrap (badge bg-success)
                                '#6c757d'  // cinzento Bootstrap (badge bg-secondary)
                            ],
                            hoverBackgroundColor: [
                                '#157347',
                                '#5c636a'
                            ],
                            borderWidth: 0,
                            hoverOffset: 6
                        }]
                    },
                    options: {
                        cutout: '60%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.label || '';
                                        const value = context.parsed;
                                        return `${label}: ${value} obras`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
}
